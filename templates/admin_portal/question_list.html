{% extends "base.html" %}
{% load dict_extras %}
{% block title %}問題一覧{% endblock %}
{% block content %}
<h1>問題一覧</h1>
<form method="get">
  <label>status: <input type="text" name="status" value="{{ request.GET.status }}"></label>
  <label>difficulty: <input type="text" name="difficulty" value="{{ request.GET.difficulty }}"></label>
  <button class="btn btn-secondary" type="submit">絞り込み</button>
</form>
<table>
  <thead>
    <tr>
      <th>ID</th><th>ジャンル</th><th>難易度</th><th>形式</th><th>status</th><th>統計</th><th>操作</th>
    </tr>
  </thead>
  <tbody>
    {% for question in questions %}
      <tr>
        <td>{{ question.id }}</td>
        <td>{{ question.scenario.genre.name }}</td>
        <td>{{ question.difficulty }}</td>
        <td>{{ question.choice_count }}</td>
        <td>{{ question.status }}</td>
        <td>
          {% with stats=stats_by_id|get_item:question.id %}
            {% if stats %}
              p1: {{ stats.phase1_correct }}/{{ stats.phase1_total }}
            {% else %}
              -
            {% endif %}
          {% endwith %}
        </td>
        <td>
          <form method="post" style="display:inline">
            {% csrf_token %}
            <input type="hidden" name="question_id" value="{{ question.id }}">
            <input type="hidden" name="action" value="publish">
            <button class="btn" type="submit">公開</button>
          </form>
          <form method="post" style="display:inline">
            {% csrf_token %}
            <input type="hidden" name="question_id" value="{{ question.id }}">
            <input type="hidden" name="action" value="archive">
            <button class="btn btn-secondary" type="submit">停止</button>
          </form>
          <form method="post" style="display:inline">
            {% csrf_token %}
            <input type="hidden" name="question_id" value="{{ question.id }}">
            <input type="hidden" name="action" value="variant">
            <button class="btn btn-secondary" type="submit">バリアント</button>
          </form>
        </td>
      </tr>
      <tr>
        <td colspan="7">
          {% for option in question.options.all %}
            {% if option.author_type == "ai" and option.generation_status == "error" %}
              <span>Option #{{ option.id }} error: {{ option.error_message }}</span>
              <a class="btn btn-secondary" href="{% url 'admin-option-retry' option.id %}">再試行</a>
            {% endif %}
          {% endfor %}
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="7">問題なし</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
